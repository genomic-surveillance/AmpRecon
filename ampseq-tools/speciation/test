#!/usr/bin/env python

import unittest
import os
from speciation.speciation import Speciate
import json

test_dir = os.path.dirname(os.path.realpath(__file__))

class TestSpeciate(unittest.TestCase):
    
    def setUp(self):
        input_vcf = os.path.join(
            test_dir, 
            "test_files", 
            "28307_1#18.vcf"
            )
        chrom_key = os.path.join(test_dir,"spec_key.json")
        species_ref = os.path.join(test_dir,"species_ref.json")

        self.obj = Speciate(input_vcf, chrom_key, species_ref)
    
    def test_read_json(self):
        match = {"A":1,"B":2}
        test_json = os.path.join(test_dir,"test_files", "test.json")
        self.assertEqual(self.obj._read_json(test_json),match)

    # def test_convert_coords_store_depth(self):
    #     truth_json = json.load(open(os.path.join(test_dir,"test_files","alleles_depth_dict.json")))
    #     self.assertEqual(self.obj.alleles_depth_dict,truth_json)

    def test_manipulate_maf(self):
        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A'], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 500}}
        }

        self.obj._manipulate_maf()
        match = {
            "F130":{'Pf': {'Allele': [], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 500}}
        }
        # print(self.alleles_depth_dict)
        self.assertEqual(self.obj.alleles_depth_dict, match)

        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A'], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 50}}
        }

        self.obj._manipulate_maf()
        match = {
            "F130":{'Pf': {'Allele': ['A'], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 50}}
        }
        # print(self.alleles_depth_dict)
        self.assertEqual(self.obj.alleles_depth_dict, match)

    def test_merge_alleles(self):
        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A'], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 50}}
        }
        self.obj.merged_alleles = self.obj._merge_alleles()

        self.assertEqual(self.obj.merged_alleles["F130"],["A"])

        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A','T'], 'DP': 1}, 'Pv': {'Allele': ['A'], 'DP': 50}}
        }
        self.obj.merged_alleles = self.obj._merge_alleles()

        self.assertEqual(self.obj.merged_alleles["F130"],["A","T"])

        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A','T'], 'DP': 1}, 'Pv': {'Allele': ['A',"T"], 'DP': 50}}
        }
        self.obj.merged_alleles = self.obj._merge_alleles()

        self.assertEqual(self.obj.merged_alleles["F130"],["A","T"])

        self.obj.alleles_depth_dict = {
            "F130":{'Pf': {'Allele': ['A'], 'DP': 1}, 'Pv': {'Allele': ['A',"T"], 'DP': 50}}
        }
        self.obj.merged_alleles = self.obj._merge_alleles()

        self.assertEqual(self.obj.merged_alleles["F130"],["A","T"])

if __name__=="__main__":
    unittest.main()
## Stage 1 Pipeline

### Introduction
The Stage 1 Pipeline is used to convert the sequence data created by [MiSeq](https://www.illumina.com/systems/sequencing-platforms/miseq.html) and generate a set of files that are compatible with Stage 2 (a set of VCF files).

Stage 1 consists of 3 steps
- Step 1 - Convert BCL into a set of CRAM files
- Step 2 - Perform science on each sample (TODO get a better idea of what is happening). This step is performed on every CRAM that is generated by Step 1
- Step 3 - Convert Step 2 BAMs into VCF files. This step is performed on every BAM that is generated by Step 2

These steps are reconstructions of those used by core sequencing.

Step 1 was created based on [this](https://aspisstaticweb.cog.sanger.ac.uk/edit.html?cfg_name=step1-28877) provided graph

Step 2 was created based on [this](https://aspisstaticweb.cog.sanger.ac.uk/edit.html?cfg_name=step2-28877) provided graph

Step 3 was created based on an existing VCF's header.

### Requirements
- A machine setup using the [deploy document](deploy.md)
- The BCL files produced by MiSeq
- [A manifest file](Manifest/readme.md)

### Deployment
The [deploy.md](deploy.md) for more details

Deploy scripts have been created for stages 1 and 2 and can be found [here](../Deploy)  
They are currently not perfect and require the following manual work
- `chown` for the correct user
- change cron script to point to `conda.sh` instead of using `conda activate`
```
if [ -f "/home/ubuntu/miniconda3/etc/profile.d/conda.sh" ]; then
    . "/home/ubuntu/miniconda3/etc/profile.d/conda.sh"
    CONDA_CHANGEPS1=false conda activate pipe-tools
fi
```
- The cron scripts are not registered as port of the deploy and have to be setup manually `*/10 * * * * /usr/local/bin/aspis-stage1/cronStage1Poller.sh`

### Usage

#### Manual Process

1. Copy the BCL files to somewhere accessible. `/mnt/bcls` is the current location
- Copy [manifest](Manifest/readme.md) to `/mnt/runs`. This can be in the root folder of the bcls.
- Goto `/usr/local/bin/aspis-stage1`
- Run `python3 run.py [batch id]`

Alternatively you can run the three different
- Run the following scripts, passing in the correct information for each script. Use absolute paths when including location arguments.
- Run `python runStep1.py [manifest location] [location of step1 scripts] [BCL location] [save path]`
- Run `python runStep2.py [manifest location] [location of step2 scripts] [references location] [save path]`
- Run `python runStep3.py [manifest location] [location of step3 scripts] [references location] [save path]`

### Output

The produced VCFs for a run can be found in `mnt/runs/[batch id]/step3-4`

### The scripts
At the lowest level stage 1 consists of a set of bash scripts. These scripts are designed to replicate each relevant node in graphs. They are designed to be executed sequentially and are numbered accordingly.

#### Step 1

- 1-bcl-to-bam.sh
  - **Program**: bambi
  - **Description**: Converts the BCLs into a single BAM
  - **Inputs**: Path to batches intensities, path to batches base calls, a platform unit, a lane, a read group id (batch number), a study name, and a set of sample alias
  - **Output**: a single bam file


- 2-bam-index-decoder.sh
  - **Program**: bambi
  - **Description**: Decodes a multiplexed SAM/BAM/CRAM file by read groups using a taglist and matrix file
  - **Inputs**: output of call 1, path of matrix file, path of taglist file
  - **Output**: a single bam file


- 3-bam-adapter-find.sh
  - **Program**: biobambam2 - bamadapterfind
  - **Description**: Scans a BAM file for contaminations by sequencing adapters
  - **Inputs**: output of call 2
  - **Output**: a single bam file


- 4-splitter.sh
  - **Program**: samtools - split
  - **Description**: Splits a file by read group
  - **Inputs**: output of call 3
  - **Output**: a set of CRAM files

#### Step 2 - per Step 1 CRAM

 - 1-collate.sh
   - **Program**: biobambam2 - bamcollate2
   - **Description**: bamcollate2 reads a SAM, BAM or CRAM file from standard input, collates the contained reads/alignments by name and writes the resulting data to standard output in BAM format.
   - **Inputs**: The path to a CRAM file
   - **Output**: a single CRAM file


 - 2-bamrest.sh
   - **Program**: biobambam2 - bamreset
   - **Description**: Bamreset reads a BAM file from standard input, transforms it to a pre-aligned state and writes the resulting data to standard output as a BAM file.
   - **Inputs**: output of call 1
   - **Output**: a single CRAM file


 - 3-adapter-clip.sh
   - **Program**: biobambam2 - bamadapterclip
   - **Description**: bamadapterclip reads a BAM file from standard input which was produced by bamadapterfind, moves the detected adapters to auxiliary fields writes the resulting data to standard output in BAM format
   - **Inputs**: output of call 2
   - **Output**: a single CRAM file


 - 4-bam-2-fastq.sh
   - **Program**: biobambam2 - bamtofastq
   - **Description**: bamtofastq reads a SAM, BAM or CRAM file from standard input and converts it to the FastQ format.
   - **Inputs**: output of call 3
   - **Output**: a single FASTQ file


 - 5-bwa-align.sh
   - **Program**: bwa mem
   - **Description**: Align 70bp-1Mbp query sequences with the BWA-MEM algorithm.
   - **Inputs**: output of call 4, a reference to the correct primer
   - **Output**: a single SAM file


 - 6-scramble.sh
   - **Program**: sCRAMble
   - **Description**: Converts the inputed FASTQ file into a BAM
   - **Inputs**: output of call 5
   - **Output**: a single BAM file

 - 7-reheader.sh
   - **Program**: samtools - reheader + custom python script 7-mergeHeaders.py
   - **Description**: Replace header information with information provided by the python script
   - **Inputs**: output of call 6, a FastQ dictionary
   - **Output**: a single BAM file


 - 8-bam_split.sh
   - **Program**: biobambam2 - bam12split
   - **Description**: bam12split reads a BAM file from standard input, projects rank pairs produced by bamcollate2 to single ranks per read and writes the resulting data as a BAM file.
   - **Inputs**: output of call 7
   - **Output**: a single BAM file


 - 9-bam12uxmerger.sh
   - **Program**: biobambam2 - bam12uxmerger
   - **Description**: am12auxmerge merges the contents of two BAM files containing the same set of reads together and writes the resulting data as a BAM file.
   - **Inputs**: output of call 8
   - **Output**: a single BAM file


 - 10-alignment_filter.sh
   - **Program**: bambi - select
   - **Description**: Give a list of SAM/BAM files with the same set of records and in the same order but aligned with different references, split reads into different files according to alignments. You have option to put unaligned reads into one of output files or a separate file.
   - **Inputs**: output of call 9, output of call 1
   - **Output**: two BAM files, a metrics.json


 - 11-bamsort.sh
   - **Program**: biobambam2 - bamsort
   - **Description**: bamsort reads a BAM, SAM or CRAM file, sorts it by coordinate (lexicographical by reference sequence id and position on reference sequence), query name (possibly including the HI aux tag for ordering alignments featuring the same query name), hash value computed for the query name or an aux tag value and writes the sorted file in BAM, SAM or CRAM format.
   - **Inputs**: output of call 10 (BAM file that is not prefixed with phix)
   - **Output**: a single BAM file


 - 12-scramble2.sh
   - **Program**: sCRAMble
   - **Description**: Converts the inputed FASTQ file into a BAM
   - **Inputs**: output of call 11
   - **Output**: a single BAM file


#### Step 3
 - 1-mpileup.sh
   - **Program**: BCFTools - mpileup
   - **Description**: Generate VCF or BCF containing genotype likelihoods for one or multiple alignment (BAM or CRAM) files.
   - **Inputs**: output of Step 2
   - **Output**: a single BCF file


 - 2-call.sh
   - **Program**: BCFTools - call
   - **Description**: SNP/indel calling. This command replaces the former bcftools view caller. Not sure what the old view command did. *TODO*
   - **Inputs**: output of call 1
   - **Output**: a single VCF file


 - 3-filter1.sh
   - **Program**: BCFTools - filter
   - **Description**: Filter VCF/BCF files using fixed thresholds - focuses on low quality, with an exclude rule of `'%QUAL<15 || MQ<20'`
   - **Inputs**: output of call 2
   - **Output**: a single VCF file


 - 4-filter2.sh
   - **Program**: BCFTools - filter
   - **Description**: Filter VCF/BCF files using fixed thresholds - focuses on low depth, with an exclude rule of `FORMAT/DP\<8`
   - **Inputs**: output of call 2
   - **Output**: a single VCF file
